#!/usr/bin/env python
"""
è¿ç§»å†²çªä¿®å¤è„šæœ¬
å®‰å…¨åœ°è§£å†³Herokuå’Œæœ¬åœ°ç¯å¢ƒä¹‹é—´çš„è¿ç§»å†²çªé—®é¢˜
"""

import os
import sys
import django
from django.core.management import execute_from_command_line
from django.db import connection

# è®¾ç½®Djangoç¯å¢ƒ
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'portfolio.settings')
django.setup()

from django.db import migrations
from django.db.migrations.recorder import MigrationRecorder
from portfolioapp.models import MobileLandingPage

def check_database_structure():
    """æ£€æŸ¥æ•°æ®åº“ä¸­çš„å®é™…è¡¨ç»“æ„"""
    print("ğŸ” æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„...")
    
    with connection.cursor() as cursor:
        # æ£€æŸ¥ mobilelandingpage è¡¨çš„åˆ— (é€‚é…SQLite)
        cursor.execute("PRAGMA table_info(portfolioapp_mobilelandingpage);")
        
        columns = cursor.fetchall()
        print("\nğŸ“‹ MobileLandingPage è¡¨çš„åˆ—:")
        for col in columns:
            # SQLite PRAGMA table_info è¿”å›: (cid, name, type, notnull, dflt_value, pk)
            print(f"  - {col[1]} ({col[2]}) {'NOT NULL' if col[3] else 'NULL'}")
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ landing_pages_image å­—æ®µ
        has_landing_pages_image = any(col[1] == 'landing_pages_image' for col in columns)
        print(f"\nâœ… landing_pages_image å­—æ®µå­˜åœ¨: {has_landing_pages_image}")
        
        return has_landing_pages_image, columns

def check_migration_status():
    """æ£€æŸ¥è¿ç§»çŠ¶æ€"""
    print("\nğŸ” æ£€æŸ¥è¿ç§»è®°å½•...")
    
    recorder = MigrationRecorder(connection)
    applied_migrations = recorder.applied_migrations()
    
    # æŸ¥æ‰¾ç›¸å…³çš„è¿ç§»
    relevant_migrations = [
        migration for migration in applied_migrations 
        if migration[0] == 'portfolioapp' and '0012' in migration[1]
    ]
    
    print("\nğŸ“‹ å·²åº”ç”¨çš„0012ç›¸å…³è¿ç§»:")
    for migration in relevant_migrations:
        print(f"  - {migration[1]}")
    
    return relevant_migrations

def create_safe_migration():
    """åˆ›å»ºå®‰å…¨çš„è¿ç§»æ¥è§£å†³å†²çª"""
    print("\nğŸ› ï¸ åˆ›å»ºå®‰å…¨çš„ä¿®å¤è¿ç§»...")
    
    # æ£€æŸ¥å­—æ®µæ˜¯å¦å·²å­˜åœ¨
    has_field, columns = check_database_structure()
    
    if has_field:
        print("âœ… landing_pages_image å­—æ®µå·²å­˜åœ¨ï¼Œæ— éœ€æ·»åŠ ")
        
        # åˆ›å»ºä¸€ä¸ªç©ºçš„è¿ç§»æ¥æ ‡è®°çŠ¶æ€
        migration_content = '''
# Generated by fix_migration_conflict.py

from django.db import migrations

class Migration(migrations.Migration):
    dependencies = [
        ('portfolioapp', '0024_auto_20250928_1256'),
    ]
    
    operations = [
        # è¿™æ˜¯ä¸€ä¸ªä¿®å¤è¿ç§»ï¼Œç”¨äºè§£å†³å­—æ®µå·²å­˜åœ¨çš„å†²çª
        # landing_pages_image å­—æ®µå·²ç»å­˜åœ¨äºæ•°æ®åº“ä¸­
    ]
'''
        
        # å†™å…¥æ–°çš„è¿ç§»æ–‡ä»¶
        migration_file = 'portfolioapp/migrations/0025_fix_landing_pages_image_conflict.py'
        with open(migration_file, 'w', encoding='utf-8') as f:
            f.write(migration_content)
        
        print(f"âœ… åˆ›å»ºä¿®å¤è¿ç§»: {migration_file}")
        return migration_file
    
    else:
        print("âŒ landing_pages_image å­—æ®µä¸å­˜åœ¨ï¼Œéœ€è¦æ·»åŠ ")
        return None

def mark_migration_as_applied(migration_name):
    """å°†è¿ç§»æ ‡è®°ä¸ºå·²åº”ç”¨"""
    print(f"\nğŸ“ æ ‡è®°è¿ç§»ä¸ºå·²åº”ç”¨: {migration_name}")
    
    recorder = MigrationRecorder(connection)
    recorder.record_applied('portfolioapp', migration_name)
    
    print("âœ… è¿ç§»å·²æ ‡è®°ä¸ºåº”ç”¨")

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸš€ å¼€å§‹ä¿®å¤è¿ç§»å†²çª...")
    print("âš ï¸  è¿™ä¸ªè„šæœ¬å°†å®‰å…¨åœ°è§£å†³è¿ç§»å†²çªï¼Œä¸ä¼šåˆ é™¤ä»»ä½•æ•°æ®")
    
    try:
        # 1. æ£€æŸ¥æ•°æ®åº“ç»“æ„
        has_field, columns = check_database_structure()
        
        # 2. æ£€æŸ¥è¿ç§»çŠ¶æ€
        applied_migrations = check_migration_status()
        
        # 3. å¦‚æœå­—æ®µå·²å­˜åœ¨ä½†è¿ç§»è®°å½•ä¸ä¸€è‡´ï¼Œåˆ›å»ºä¿®å¤è¿ç§»
        if has_field:
            # æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºä¿®å¤è¿ç§»
            local_migration_exists = os.path.exists('portfolioapp/migrations/0012_remove_socialmediapost_mockup_image_1_and_more.py')
            
            if local_migration_exists:
                print("\nğŸ”§ æ£€æµ‹åˆ°æœ¬åœ°è¿ç§»æ–‡ä»¶ä¸Herokuä¸åŒæ­¥")
                print("åˆ›å»ºä¿®å¤è¿ç§»æ¥è§£å†³å†²çª...")
                
                # åˆ›å»ºä¿®å¤è¿ç§»
                fix_migration = create_safe_migration()
                
                if fix_migration:
                    print("\nâœ… ä¿®å¤è¿ç§»åˆ›å»ºæˆåŠŸï¼")
                    print("\nğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:")
                    print("1. è¿è¡Œ: python manage.py migrate")
                    print("2. æäº¤æ›´æ”¹: git add . && git commit -m 'Fix migration conflict'")
                    print("3. æ¨é€åˆ°Heroku: git push skylarhu main")
                else:
                    print("âŒ æ— æ³•åˆ›å»ºä¿®å¤è¿ç§»")
            else:
                print("\nâœ… æœ¬åœ°è¿ç§»æ–‡ä»¶ä¸HerokuåŒæ­¥ï¼Œæ— éœ€ä¿®å¤")
        else:
            print("\nâŒ æ•°æ®åº“ä¸­ç¼ºå°‘å¿…è¦å­—æ®µï¼Œéœ€è¦æ‰‹åŠ¨ä¿®å¤")
        
        print("\nğŸ‰ è¿ç§»å†²çªåˆ†æå®Œæˆï¼")
        
    except Exception as e:
        print(f"\nâŒ ä¿®å¤è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {str(e)}")
        print("\nğŸ” è¯¦ç»†é”™è¯¯ä¿¡æ¯:")
        import traceback
        traceback.print_exc()
        sys.exit(1)

if __name__ == "__main__":
    main()