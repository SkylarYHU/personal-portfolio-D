#!/usr/bin/env python
"""
ä¿®å¤Herokuè¿ç§»å†²çªè„šæœ¬
å®‰å…¨åœ°è§£å†³æœ¬åœ°å’ŒHerokuç¯å¢ƒä¹‹é—´çš„è¿ç§»å†å²ä¸ä¸€è‡´é—®é¢˜
"""

import os
import sys
import django

# è®¾ç½®Djangoç¯å¢ƒ
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'portfolio.settings')
django.setup()

from django.db import connection
from django.db.migrations.recorder import MigrationRecorder

def check_migration_status():
    """æ£€æŸ¥æœ¬åœ°å’ŒHerokuçš„è¿ç§»çŠ¶æ€å·®å¼‚"""
    print("ğŸ” æ£€æŸ¥è¿ç§»çŠ¶æ€...")
    
    recorder = MigrationRecorder(connection)
    applied_migrations = recorder.applied_migrations()
    
    # è·å–portfolioappçš„æ‰€æœ‰å·²åº”ç”¨è¿ç§»
    portfolioapp_migrations = [m for m in applied_migrations if m[0] == 'portfolioapp']
    
    print("\nğŸ“‹ æœ¬åœ°å·²åº”ç”¨çš„portfolioappè¿ç§»:")
    for migration in sorted(portfolioapp_migrations):
        print(f"  - {migration[1]}")
    
    return portfolioapp_migrations

def sync_migrations_with_heroku():
    """åŒæ­¥è¿ç§»çŠ¶æ€ä»¥åŒ¹é…Heroku"""
    print("\nğŸ”„ åŒæ­¥è¿ç§»çŠ¶æ€ä»¥åŒ¹é…Heroku...")
    
    recorder = MigrationRecorder(connection)
    
    # Herokuä¸Šå­˜åœ¨çš„è¿ç§»ä½†æœ¬åœ°å¯èƒ½ç¼ºå¤±çš„
    heroku_migrations = [
        '0012_mobilelandingpage_landing_pages_image',
        '0013_socialmediapost_mockup_image_1_text_and_more',
        '0014_ecommerceproject',
        '0015_powerpointpresentation',
        '0016_powerpointpresentation_powerpoint_link_url',
        '0017_powerpointpresentation_tags',
        '0018_remove_powerpointpresentation_design_approach_content_and_more',
        '0019_powerpointpresentation_home_preview_image_and_more',
        '0020_socialmediapost_preview_image',
        '0021_auto_20250927_1114',
        '0022_remove_socialmediapost_mockup_image_1_and_more',
        '0023_mobilelandingpage_tools_apps',
        '0024_socialmediapost_category'
    ]
    
    # æœ¬åœ°ç‰¹æœ‰çš„è¿ç§»
    local_only_migrations = [
        '0012_remove_socialmediapost_mockup_image_1_and_more',
        '0013_auto_20250928_0402',
        '0014_remove_socialmediapost_mockup_image_1_and_more',
        '0015_auto_20250928_1253',
        '0016_auto_20250928_1254',
        '0017_auto_20250928_1254',
        '0018_auto_20250928_1256',
        '0019_auto_20250928_1256',
        '0020_auto_20250928_1256',
        '0021_auto_20250928_1256',
        '0022_auto_20250928_1256',
        '0023_auto_20250928_1256',
        '0024_auto_20250928_1256',
        '0025_fix_landing_pages_image_conflict'
    ]
    
    print("\nğŸ“ æ ‡è®°Herokuè¿ç§»ä¸ºå·²åº”ç”¨...")
    for migration in heroku_migrations:
        if ('portfolioapp', migration) not in recorder.applied_migrations():
            print(f"  æ ‡è®° {migration} ä¸ºå·²åº”ç”¨")
            recorder.record_applied('portfolioapp', migration)
    
    print("\nğŸ—‘ï¸  æ¸…ç†æœ¬åœ°ç‰¹æœ‰çš„è¿ç§»è®°å½•...")
    for migration in local_only_migrations:
        if ('portfolioapp', migration) in recorder.applied_migrations():
            print(f"  åˆ é™¤ {migration} è®°å½•")
            recorder.record_unapplied('portfolioapp', migration)
    
    print("\nâœ… è¿ç§»çŠ¶æ€åŒæ­¥å®Œæˆï¼")

def create_compatible_migration():
    """åˆ›å»ºä¸Herokuå…¼å®¹çš„æ–°è¿ç§»"""
    print("\nğŸ› ï¸  åˆ›å»ºä¸Herokuå…¼å®¹çš„è¿ç§»æ–‡ä»¶...")
    
    migration_content = '''# Generated by fix_heroku_migration_conflict.py

from django.db import migrations

class Migration(migrations.Migration):

    dependencies = [
        ('portfolioapp', '0024_socialmediapost_category'),
    ]

    operations = [
        # è¿™æ˜¯ä¸€ä¸ªå…¼å®¹æ€§è¿ç§»ï¼Œç”¨äºç¡®ä¿æœ¬åœ°å’ŒHerokuç¯å¢ƒçš„ä¸€è‡´æ€§
        # æ‰€æœ‰æ¨¡å‹å­—æ®µå˜æ›´å·²åº”ç”¨åˆ°æ•°æ®åº“
    ]
'''
    
    # å†™å…¥æ–°çš„è¿ç§»æ–‡ä»¶
    migration_file = 'portfolioapp/migrations/0025_auto_20250928_1500.py'
    with open(migration_file, 'w', encoding='utf-8') as f:
        f.write(migration_content)
    
    print(f"âœ… åˆ›å»ºå…¼å®¹æ€§è¿ç§»: {migration_file}")

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸš€ å¼€å§‹ä¿®å¤Herokuè¿ç§»å†²çª...")
    print("âš ï¸  è¿™ä¸ªè„šæœ¬å°†å®‰å…¨åœ°è§£å†³è¿ç§»å†å²ä¸ä¸€è‡´é—®é¢˜ï¼Œä¸ä¼šåˆ é™¤ä»»ä½•æ•°æ®")
    
    try:
        # 1. æ£€æŸ¥å½“å‰è¿ç§»çŠ¶æ€
        current_migrations = check_migration_status()
        
        # 2. åŒæ­¥è¿ç§»çŠ¶æ€
        sync_migrations_with_heroku()
        
        # 3. åˆ›å»ºå…¼å®¹æ€§è¿ç§»
        create_compatible_migration()
        
        print("\nğŸ‰ è¿ç§»å†²çªä¿®å¤å®Œæˆï¼")
        print("\nğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:")
        print("1. è¿è¡Œ: git add . && git commit -m 'Fix migration conflict with Heroku'")
        print("2. æ¨é€åˆ°Heroku: git push heroku main")
        print("3. å¦‚æœéœ€è¦ï¼Œè¿è¡Œ: heroku run python manage.py migrate --app your-app-name")
        
    except Exception as e:
        print(f"\nâŒ ä¿®å¤è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {str(e)}")
        print("\nğŸ” è¯¦ç»†é”™è¯¯ä¿¡æ¯:")
        import traceback
        traceback.print_exc()
        sys.exit(1)

if __name__ == "__main__":
    main()