#!/usr/bin/env python
"""
ä¿®å¤Herokuéƒ¨ç½²é—®é¢˜çš„ç»¼åˆè„šæœ¬
è§£å†³è¿ç§»å†²çªå’Œæ¨¡æ¿è¯­æ³•é”™è¯¯
"""

import os
import sys
import django

# è®¾ç½®Djangoç¯å¢ƒ
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'portfolio.settings')
django.setup()

from django.db import connection
from django.db.migrations.recorder import MigrationRecorder

def fix_migration_conflicts():
    """ä¿®å¤è¿ç§»å†²çª"""
    print("ğŸ”§ ä¿®å¤è¿ç§»å†²çª...")
    
    recorder = MigrationRecorder(connection)
    
    # æ£€æŸ¥å¹¶ä¿®å¤å¯èƒ½çš„é‡å¤è¿ç§»
    migrations_to_check = [
        '0012_remove_socialmediapost_mockup_image_1_and_more',
        '0025_fix_landing_pages_image_conflict',
        '0025_auto_20250928_1500'
    ]
    
    print("  æ£€æŸ¥è¿ç§»çŠ¶æ€...")
    applied_migrations = recorder.applied_migrations()
    
    # ç¡®ä¿ä¾èµ–çš„è¿ç§»å­˜åœ¨
    required_migrations = [
        ('portfolioapp', '0024_socialmediapost_category'),
    ]
    
    for migration in required_migrations:
        if migration not in applied_migrations:
            print(f"  æ ‡è®° {migration[1]} ä¸ºå·²åº”ç”¨")
            recorder.record_applied(migration[0], migration[1])
    
    print("âœ… è¿ç§»å†²çªä¿®å¤å®Œæˆ")

def check_template_syntax():
    """æ£€æŸ¥æ¨¡æ¿è¯­æ³•"""
    print("\nğŸ” æ£€æŸ¥æ¨¡æ¿è¯­æ³•...")
    
    template_path = 'portfolioapp/templates/portfolioapp/ecommerce_detail.html'
    
    if not os.path.exists(template_path):
        print(f"âŒ æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨: {template_path}")
        return False
    
    with open(template_path, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # æ£€æŸ¥Djangoæ¨¡æ¿æ ‡ç­¾æ˜¯å¦æ­£ç¡®é…å¯¹
    if content.count('{% if') != content.count('{% endif %}'):
        print("âŒ æ¨¡æ¿ä¸­ifå’Œendifæ ‡ç­¾æ•°é‡ä¸åŒ¹é…")
        print(f"   ifæ ‡ç­¾æ•°é‡: {content.count('{% if')}")
        print(f"   endifæ ‡ç­¾æ•°é‡: {content.count('{% endif %}')}")
        return False
    
    # æ£€æŸ¥æ˜¯å¦æœ‰å­¤ç«‹çš„endifæ ‡ç­¾
    lines = content.split('\n')
    for i, line in enumerate(lines, 1):
        if 'endif' in line and '{% endif %}' not in line:
            print(f"âŒ ç¬¬{i}è¡Œå‘ç°å­¤ç«‹çš„endifæ ‡ç­¾: {line.strip()}")
            return False
    
    print("âœ… æ¨¡æ¿è¯­æ³•æ£€æŸ¥é€šè¿‡")
    return True

def create_compatible_migration():
    """åˆ›å»ºå…¼å®¹çš„è¿ç§»æ–‡ä»¶"""
    print("\nğŸ› ï¸  åˆ›å»ºå…¼å®¹çš„è¿ç§»æ–‡ä»¶...")
    
    migration_content = '''# Generated by fix_heroku_deployment.py

from django.db import migrations

class Migration(migrations.Migration):

    dependencies = [
        ('portfolioapp', '0024_socialmediapost_category'),
    ]

    operations = [
        # è¿™æ˜¯ä¸€ä¸ªå…¼å®¹æ€§è¿ç§»ï¼Œç”¨äºç¡®ä¿æœ¬åœ°å’ŒHerokuç¯å¢ƒçš„ä¸€è‡´æ€§
        # æ‰€æœ‰æ¨¡å‹å­—æ®µå˜æ›´å·²åº”ç”¨åˆ°æ•°æ®åº“
    ]
'''
    
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼çš„è¿ç§»æ–‡ä»¶
    migration_files = os.listdir('portfolioapp/migrations')
    existing_migration = None
    for file in migration_files:
        if file.startswith('0025_') and file.endswith('.py'):
            existing_migration = file
            break
    
    if existing_migration:
        print(f"  å‘ç°ç°æœ‰è¿ç§»æ–‡ä»¶: {existing_migration}")
        # å¤‡ä»½ç°æœ‰æ–‡ä»¶
        backup_name = f"{existing_migration}.bak"
        os.rename(f"portfolioapp/migrations/{existing_migration}", 
                 f"portfolioapp/migrations/{backup_name}")
        print(f"  å·²å¤‡ä»½ä¸º: {backup_name}")
    
    # åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶
    migration_file = 'portfolioapp/migrations/0025_heroku_compatibility_fix.py'
    with open(migration_file, 'w', encoding='utf-8') as f:
        f.write(migration_content)
    
    print(f"âœ… åˆ›å»ºå…¼å®¹æ€§è¿ç§»: {migration_file}")

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸš€ å¼€å§‹ä¿®å¤Herokuéƒ¨ç½²é—®é¢˜...")
    print("âš ï¸  è¿™ä¸ªè„šæœ¬å°†å®‰å…¨åœ°è§£å†³è¿ç§»å†²çªå’Œæ¨¡æ¿é—®é¢˜ï¼Œä¸ä¼šåˆ é™¤ä»»ä½•æ•°æ®")
    
    try:
        # 1. ä¿®å¤è¿ç§»å†²çª
        fix_migration_conflicts()
        
        # 2. æ£€æŸ¥æ¨¡æ¿è¯­æ³•
        if not check_template_syntax():
            print("\nâŒ æ¨¡æ¿è¯­æ³•æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¿®å¤æ¨¡æ¿æ–‡ä»¶")
            sys.exit(1)
        
        # 3. åˆ›å»ºå…¼å®¹æ€§è¿ç§»
        create_compatible_migration()
        
        print("\nğŸ‰ æ‰€æœ‰ä¿®å¤å®Œæˆï¼")
        print("\nğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:")
        print("1. è¿è¡Œ: git add . && git commit -m 'Fix Heroku deployment issues'")
        print("2. æ¨é€åˆ°Heroku: git push heroku main")
        print("3. å¦‚æœéœ€è¦ï¼Œè¿è¡Œ: heroku run python manage.py migrate --app your-app-name")
        
    except Exception as e:
        print(f"\nâŒ ä¿®å¤è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {str(e)}")
        print("\nğŸ” è¯¦ç»†é”™è¯¯ä¿¡æ¯:")
        import traceback
        traceback.print_exc()
        sys.exit(1)

if __name__ == "__main__":
    main()