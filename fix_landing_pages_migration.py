#!/usr/bin/env python
"""
ä¿®å¤landing_pages_imageå­—æ®µè¿ç§»å†²çªçš„è„šæœ¬
"""

import os
import sys
import django

# è®¾ç½®Djangoç¯å¢ƒ
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'portfolio.settings')
django.setup()

from django.db import connection
from django.db.migrations.recorder import MigrationRecorder

def fix_landing_pages_migration():
    """ä¿®å¤landing_pages_imageå­—æ®µçš„è¿ç§»å†²çª"""
    print("ğŸ”§ ä¿®å¤landing_pages_imageå­—æ®µè¿ç§»å†²çª...")
    
    recorder = MigrationRecorder(connection)
    
    # æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å·²å­˜åœ¨landing_pages_imageå­—æ®µ
    field_exists = False
    with connection.cursor() as cursor:
        # æ£€æŸ¥å­—æ®µæ˜¯å¦å·²å­˜åœ¨ï¼ˆé€‚é…ä¸åŒæ•°æ®åº“ï¼‰
        if connection.vendor == 'postgresql':
            # PostgreSQLæŸ¥è¯¢
            cursor.execute("""
                SELECT column_name 
                FROM information_schema.columns 
                WHERE table_name = 'portfolioapp_mobilelandingpage' 
                AND column_name = 'landing_pages_image';
            """)
            field_exists = cursor.fetchone() is not None
        else:
            # SQLiteæŸ¥è¯¢
            cursor.execute("""
                PRAGMA table_info(portfolioapp_mobilelandingpage);
            """)
            columns = cursor.fetchall()
            field_exists = any(col[1] == 'landing_pages_image' for col in columns)
        
        print(f"  landing_pages_imageå­—æ®µå­˜åœ¨: {field_exists}")
        
        # å¦‚æœå­—æ®µå·²å­˜åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ç›¸å…³çš„è¿ç§»è¢«æ­£ç¡®æ ‡è®°
        if field_exists:
            # æ£€æŸ¥éœ€è¦æ ‡è®°ä¸ºå·²åº”ç”¨çš„è¿ç§»
            migrations_to_mark = [
                ('portfolioapp', '0012_mobilelandingpage_landing_pages_image'),
                ('portfolioapp', '0023_mobilelandingpage_tools_apps'),
            ]
            
            applied_migrations = recorder.applied_migrations()
            
            for migration in migrations_to_mark:
                if migration not in applied_migrations:
                    print(f"  æ ‡è®°è¿ç§» {migration[1]} ä¸ºå·²åº”ç”¨")
                    recorder.record_applied(migration[0], migration[1])
                else:
                    print(f"  è¿ç§» {migration[1]} å·²ç»æ ‡è®°ä¸ºå·²åº”ç”¨")
        
        # ç¡®ä¿æœ‰é—®é¢˜çš„è¿ç§»è¢«æ ‡è®°ä¸ºå·²åº”ç”¨
        problematic_migrations = [
            ('portfolioapp', '0012_remove_socialmediapost_mockup_image_1_and_more'),
        ]
        
        applied_migrations = recorder.applied_migrations()
        for migration in problematic_migrations:
            if migration in applied_migrations:
                print(f"  åˆ é™¤è¿ç§»è®°å½• {migration[1]}")
                recorder.record_unapplied(migration[0], migration[1])
    
    print("âœ… landing_pages_imageå­—æ®µè¿ç§»å†²çªä¿®å¤å®Œæˆ")

def create_safe_migration():
    """åˆ›å»ºå®‰å…¨çš„è¿ç§»æ–‡ä»¶"""
    print("\nğŸ› ï¸  åˆ›å»ºå®‰å…¨çš„è¿ç§»æ–‡ä»¶...")
    
    migration_content = '''# Generated by fix_landing_pages_migration.py

from django.db import migrations

class Migration(migrations.Migration):

    dependencies = [
        ('portfolioapp', '0024_socialmediapost_category'),
    ]

    operations = [
        # è¿™æ˜¯ä¸€ä¸ªå®‰å…¨çš„è¿ç§»ï¼Œç”¨äºè§£å†³å­—æ®µå·²å­˜åœ¨çš„å†²çª
        # landing_pages_imageå­—æ®µå·²ç»å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œæ— éœ€å†æ¬¡åˆ›å»º
    ]
'''
    
    # åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶
    migration_file = 'portfolioapp/migrations/0026_safe_landing_pages_fix.py'
    
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if os.path.exists(migration_file):
        print(f"  è¿ç§»æ–‡ä»¶ {migration_file} å·²å­˜åœ¨")
        return
    
    with open(migration_file, 'w', encoding='utf-8') as f:
        f.write(migration_content)
    
    print(f"âœ… åˆ›å»ºå®‰å…¨è¿ç§»: {migration_file}")

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸš€ å¼€å§‹ä¿®å¤landing_pages_imageå­—æ®µè¿ç§»å†²çª...")
    
    try:
        # 1. ä¿®å¤è¿ç§»å†²çª
        fix_landing_pages_migration()
        
        # 2. åˆ›å»ºå®‰å…¨çš„è¿ç§»æ–‡ä»¶
        create_safe_migration()
        
        print("\nğŸ‰ è¿ç§»å†²çªä¿®å¤å®Œæˆï¼")
        print("\nğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:")
        print("1. è¿è¡Œ: git add . && git commit -m 'Fix landing_pages_image migration conflict'")
        print("2. æ¨é€åˆ°Heroku: git push heroku main")
        print("3. è¿è¡Œ: heroku run python manage.py migrate --app your-app-name")
        
    except Exception as e:
        print(f"\nâŒ ä¿®å¤è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {str(e)}")
        print("\nğŸ” è¯¦ç»†é”™è¯¯ä¿¡æ¯:")
        import traceback
        traceback.print_exc()
        sys.exit(1)

if __name__ == "__main__":
    main()